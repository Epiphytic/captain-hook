name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-linux:
    name: Build x86_64-unknown-linux-gnu
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install stable Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry & target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-release-

      - name: Build
        run: cargo build --release

      - name: Package binary
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          BIN_NAME="hookwise"
          BUILD_TARGET="x86_64-unknown-linux-gnu"
          ARCHIVE_NAME="${BIN_NAME}-${TAG_NAME}-${BUILD_TARGET}"

          mkdir -p staging
          cp "target/release/${BIN_NAME}" staging/
          cd staging

          tar czf "../${ARCHIVE_NAME}.tar.gz" "${BIN_NAME}"
          cd ..

          sha256sum "${ARCHIVE_NAME}.tar.gz" > "${ARCHIVE_NAME}.tar.gz.sha256"

      - name: Package plugin files
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          ARCHIVE_NAME="hookwise-${TAG_NAME}-plugin-files"
          tar czf "${ARCHIVE_NAME}.tar.gz" \
            hooks/hooks.json \
            hooks/gemini-hooks.json \
            .claude-plugin/plugin.json \
            gemini-extension.json \
            GEMINI.md \
            skills/register/SKILL.md \
            skills/disable/SKILL.md \
            skills/enable/SKILL.md \
            skills/switch/SKILL.md \
            skills/status/SKILL.md \
            commands/hookwise/register.toml \
            commands/hookwise/disable.toml \
            commands/hookwise/enable.toml \
            commands/hookwise/switch.toml \
            commands/hookwise/status.toml \
            agents/supervisor.md

          sha256sum "${ARCHIVE_NAME}.tar.gz" > "${ARCHIVE_NAME}.tar.gz.sha256"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hookwise-x86_64-unknown-linux-gnu
          path: |
            hookwise-*.tar.gz
            hookwise-*.sha256

  build-macos:
    name: Build aarch64-apple-darwin
    runs-on: [self-hosted, hookwise, macos]
    steps:
      - uses: actions/checkout@v4

      - name: Install stable Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry & target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-release-

      - name: Build
        run: cargo build --release

      - name: Package binary
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          BIN_NAME="hookwise"
          BUILD_TARGET="aarch64-apple-darwin"
          ARCHIVE_NAME="${BIN_NAME}-${TAG_NAME}-${BUILD_TARGET}"

          mkdir -p staging
          cp "target/release/${BIN_NAME}" staging/
          cd staging

          tar czf "../${ARCHIVE_NAME}.tar.gz" "${BIN_NAME}"
          cd ..

          shasum -a 256 "${ARCHIVE_NAME}.tar.gz" > "${ARCHIVE_NAME}.tar.gz.sha256"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hookwise-aarch64-apple-darwin
          path: |
            hookwise-*.tar.gz
            hookwise-*.sha256

  install-test:
    name: Install validation
    needs: build-linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download x86_64 binary artifact
        uses: actions/download-artifact@v4
        with:
          name: hookwise-x86_64-unknown-linux-gnu
          path: artifacts

      - name: Extract binary
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          tar xzf "artifacts/hookwise-${TAG_NAME}-x86_64-unknown-linux-gnu.tar.gz"
          chmod +x hookwise

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run install script
        run: |
          chmod +x scripts/install.sh
          ./scripts/install.sh --binary ./hookwise --scope user

      - name: Add install dir to PATH
        run: echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Verify hookwise --version
        run: |
          hookwise --version
          echo "Version check passed"

      - name: Verify hookwise --help
        run: |
          HELP_OUTPUT=$(hookwise --help)
          echo "$HELP_OUTPUT"
          echo "$HELP_OUTPUT" | grep -q "check" || { echo "FAIL: --help missing 'check' subcommand"; exit 1; }
          echo "$HELP_OUTPUT" | grep -q "register" || { echo "FAIL: --help missing 'register' subcommand"; exit 1; }
          echo "$HELP_OUTPUT" | grep -q "mcp-server" || { echo "FAIL: --help missing 'mcp-server' subcommand"; exit 1; }
          echo "$HELP_OUTPUT" | grep -q "self-update" || { echo "FAIL: --help missing 'self-update' subcommand"; exit 1; }
          echo "Help check passed"

      - name: Smoke test hookwise check
        run: |
          # Set up config and register a session for the smoke test
          cd /tmp
          hookwise init
          hookwise register --session-id smoke-test --role maintainer

          # Reduce human timeout for CI (default 60s is too slow for smoke tests)
          sed -i 's/human_timeout_secs: 60/human_timeout_secs: 3/' .hookwise/policy.yml

          # Run a check â€” maintainer role with a Bash command should produce valid JSON
          OUTPUT=$(echo '{"session_id":"smoke-test","tool_name":"Bash","tool_input":{"command":"ls"},"cwd":"/tmp"}' | hookwise check 2>/dev/null || true)
          echo "Output: $OUTPUT"

          # Validate it's JSON with hookSpecificOutput.permissionDecision
          echo "$OUTPUT" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert 'hookSpecificOutput' in data, 'missing hookSpecificOutput'
          assert 'permissionDecision' in data['hookSpecificOutput'], 'missing permissionDecision'
          decision = data['hookSpecificOutput']['permissionDecision']
          assert decision in ('allow', 'deny', 'ask'), f'unexpected decision: {decision}'
          print(f'Valid response: permissionDecision={decision}')
          "
          echo "Claude format smoke test passed"

          # Test Gemini format output
          GEMINI_OUTPUT=$(echo '{"session_id":"smoke-test","tool_name":"write_file","tool_input":{"file_path":"test.txt","content":"hello"},"cwd":"/tmp","hook_event_name":"BeforeTool","timestamp":"2026-02-09T00:00:00Z"}' | hookwise check --format gemini 2>/dev/null || true)
          echo "Gemini output: $GEMINI_OUTPUT"

          echo "$GEMINI_OUTPUT" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          assert 'decision' in data, 'missing decision field'
          decision = data['decision']
          assert decision in ('allow', 'deny', 'ask'), f'unexpected decision: {decision}'
          assert 'hookSpecificOutput' not in data, 'Gemini format should not have hookSpecificOutput'
          print(f'Valid Gemini response: decision={decision}')
          "
          echo "Gemini format smoke test passed"

          # Clean up
          rm -rf /tmp/.hookwise

      - name: Verify plugin registered with Claude
        run: |
          # Verify the plugin appears in Claude's plugin list
          claude plugin list 2>&1 | grep -q "hookwise@hookwise-local" || { echo "FAIL: hookwise not in claude plugin list"; exit 1; }
          echo "Plugin registered with Claude CLI"

          # Verify plugin files in the local marketplace directory
          test -f ~/.hookwise/plugin/hooks/hooks.json || { echo "FAIL: hooks.json not found"; exit 1; }
          python3 -c "import json; json.load(open('$HOME/.hookwise/plugin/hooks/hooks.json'))"
          echo "hooks.json is valid JSON"

          test -f ~/.hookwise/plugin/.claude-plugin/plugin.json || { echo "FAIL: plugin.json not found"; exit 1; }
          test -f ~/.hookwise/plugin/.claude-plugin/marketplace.json || { echo "FAIL: marketplace.json not found"; exit 1; }
          echo "Plugin and marketplace manifests present"

          # Verify plugin cached by Claude
          test -d ~/.claude/plugins/cache/hookwise-local/hookwise/ || { echo "FAIL: plugin not in Claude cache"; exit 1; }
          echo "Plugin cached by Claude"

          # Verify skill files exist
          for skill in register disable enable switch status; do
            test -f ~/.hookwise/plugin/skills/$skill/SKILL.md || { echo "FAIL: skills/$skill/SKILL.md not found"; exit 1; }
          done
          echo "All skill files present"

          test -f ~/.hookwise/plugin/agents/supervisor.md || { echo "FAIL: agents/supervisor.md not found"; exit 1; }
          echo "Agent file present"

          echo "Plugin verification passed"

  release:
    name: Create GitHub Release
    needs: [install-test, build-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/hookwise-*.tar.gz
            artifacts/hookwise-*.sha256
